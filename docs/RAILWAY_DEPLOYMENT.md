# Railway Deployment Guide

Complete guide to deploying TrossApp backend to Railway.

## Platform-Agnostic Architecture

**TrossApp uses deployment-adapter.js for zero-config multi-platform support.**

The backend automatically detects Railway (via `RAILWAY_ENVIRONMENT` env var) and uses `DATABASE_URL` for database connection. No code changes needed if you switch to Render, Fly.io, Heroku, or AWS—just change environment variables.

See `backend/config/deployment-adapter.js` for platform detection logic.

## Prerequisites

- GitHub account connected to Railway
- Railway account (sign up at https://railway.app)
- This repository pushed to GitHub

---

## Initial Setup (One-Time)

### 1. Create Railway Project

1. Go to https://railway.app/new
2. Click "Deploy from GitHub repo"
3. Select `losamgmt/tross-app`
4. Railway will detect Node.js and create a service

### 2. Add PostgreSQL Database

1. In your Railway project, click "+ New"
2. Select "Database" → "PostgreSQL"
3. Railway provisions database automatically
4. Note: `DATABASE_URL` environment variable is auto-created

### 3. Configure Environment Variables

In Railway project settings → Variables, add:

```bash
# Auto-generated by Railway (don't add these manually)
DATABASE_URL=${DATABASE_URL}  # Automatically linked to PostgreSQL service
PORT=${PORT}  # Railway assigns this dynamically

# Required: Add these manually
NODE_ENV=production
JWT_SECRET=<generate-secure-secret-32-chars-minimum>

# Auth0 Configuration (from your Auth0 dashboard)
AUTH0_DOMAIN=<your-tenant>.us.auth0.com
AUTH0_AUDIENCE=https://api.trossapp.com
AUTH0_ISSUER=https://<your-tenant>.us.auth0.com/

# Optional: Rate limiting and security
RATE_LIMIT_WINDOW_MS=900000
RATE_LIMIT_MAX_REQUESTS=100

# Optional: CORS (set after Vercel deployment)
FRONTEND_URL=https://trossapp.vercel.app
ALLOWED_ORIGINS=https://trossapp.vercel.app,http://localhost:8080
```

### 4. Run Database Migrations

**Option A: Railway CLI (Recommended)**

```bash
# Install Railway CLI
npm i -g @railway/cli

# Login
railway login

# Link to your project
railway link

# Run migrations
railway run bash
cd backend/migrations
for f in *.sql; do psql $DATABASE_URL -f $f; done
exit
```

**Option B: Railway Dashboard**

1. Click your service → "Deploy"
2. Add one-time deployment command:
   ```bash
   cd backend/migrations && for f in *.sql; do psql $DATABASE_URL -f $f; done
   ```
3. After migrations succeed, remove this command

### 5. Deploy!

Railway auto-deploys on every push to `main`. First deployment:

1. Commit `railway.json` to your repo
2. Push to GitHub
3. Railway detects changes and deploys
4. Monitor logs in Railway dashboard

---

## Verify Deployment

### Check Health Endpoint

```bash
# Railway gives you a public URL like: https://trossapp-production.up.railway.app
curl https://<your-app>.up.railway.app/api/health

# Expected response:
{
  "status": "healthy",
  "timestamp": "2025-11-19T...",
  "database": {
    "connected": true,
    "pool": {
      "total": 10,
      "idle": 10,
      "waiting": 0
    }
  }
}
```

### Check API Documentation

Visit: `https://<your-app>.up.railway.app/api-docs`

---

## Ongoing Usage

### Auto-Deploy on Push

Every push to `main` triggers automatic deployment:

```bash
git push origin main  # Railway auto-deploys in ~60 seconds
```

### View Logs

```bash
# Via CLI
railway logs

# Or via dashboard:
# Railway project → Select service → "Deployments" → Click latest → "View Logs"
```

### Environment Variables

Update in Railway dashboard:
- Project → Service → "Variables"
- Changes apply on next deployment
- Click "Redeploy" to apply immediately

### Database Management

**Backup:**
```bash
railway run bash
pg_dump $DATABASE_URL > backup-$(date +%Y%m%d).sql
exit
```

**Connect via CLI:**
```bash
railway run bash
psql $DATABASE_URL
```

**View in GUI:**
- Railway dashboard → PostgreSQL service → "Data" tab

---

## Cost Estimates

Railway pricing (as of 2025):
- **Starter Plan:** $5/month
- **Usage-based:** ~$0.000231/GB-hour (memory), ~$0.000463/vCPU-hour
- **PostgreSQL:** Included in usage

**Expected monthly cost:** $10-15 for hobby project

Free trial: $5 credit (enough for ~1 month testing)

---

## Troubleshooting

### Deployment Fails

**Check logs:**
```bash
railway logs
```

**Common issues:**
- Missing environment variables → Add in Railway dashboard
- Migration failures → Run migrations manually
- Port conflicts → Railway uses `$PORT` env var, ensure `server.js` uses it

### Database Connection Fails

**Verify DATABASE_URL:**
```bash
railway run bash
echo $DATABASE_URL  # Should show postgres://...
```

**Test connection:**
```bash
railway run bash
psql $DATABASE_URL -c "SELECT 1;"
```

### Health Check Fails

**Verify route exists:**
```bash
curl https://<your-app>.up.railway.app/api/health -v
```

**Check server.js uses correct port:**
```javascript
const PORT = process.env.PORT || 3001;
```

---

## Custom Domain (Optional)

1. Railway project → Service → "Settings" → "Domains"
2. Click "Generate Domain" or "Custom Domain"
3. Add CNAME record in your DNS provider:
   ```
   api.trossapp.com → <your-app>.up.railway.app
   ```
4. SSL certificate auto-generated

---

## Rolling Back

If a deployment breaks production:

```bash
# Via CLI
railway rollback

# Or via dashboard:
# Railway project → "Deployments" → Find working deployment → "Redeploy"
```

---

## Next Steps

After Railway is running:

1. ✅ Update `ALLOWED_ORIGINS` in Railway with Vercel URL
2. ✅ Add Railway URL to Auth0 allowed callback URLs
3. ✅ Update frontend `.env` with Railway API URL
4. ✅ Test end-to-end flow (frontend → Railway backend → PostgreSQL)

---

**Keep this file for reference!** Add to `.gitignore` if it contains secrets.
